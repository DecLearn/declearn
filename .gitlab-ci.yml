# Shared configuration elements between test jobs.
.config:
  # Official Python language image, in version 3.8(.latest)
  image: python:3.8
  # Ensure pip cache is preserved.
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Set up a virtual environment, with latest pip and tox installed.
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install -U pip
    - pip install -U tox
  # Configure coverage export and collection.
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  coverage: /(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
  tags:
    - ci.inria.fr
    - small

cache:
  paths:
    - .cache/pip

# Basic test suite: skip GPU use and a few extra integration tests scenarios.
# This job is called when commits are pushed to a non-draft MR branch.
# It may also be called manually on commits to draft MR branches.
test-minimal:
  extends:
    .config
  script:
    - tox -e py38 -- --cpu-only
  rules:
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event") &&
          ($CI_MERGE_REQUEST_TITLE !~ /^Draft:.*/)
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event") &&
          ($CI_MERGE_REQUEST_TITLE =~ /^Draft:.*/)
      when: manual
      allow_failure: true

# Exhaustive test suite: lint the code, run all tests, use GPU when available.
# This job is called when commits are pushed to a main branch.
# It may also be called manually on commits to MR branches.
test-maximal:
  extends:
    .config
  script:
    - tox -e py38 -- --fulltest
  rules:
    - if: ($CI_PIPELINE_SOURCE == "push") &&
          (
            ($CI_COMMIT_BRANCH == "develop") ||
            ($CI_COMMIT_BRANCH =~ "/^r\d\.\d+/")
          )
    - if: ($CI_PIPELINE_SOURCE == "merge_request_event")
      when: manual
      allow_failure: true  # do not block the base "test" pipeline
  tags:
    - gpu
    - magnet
